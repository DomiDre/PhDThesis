\providecommand{\main}{../../../..}
\documentclass[\main/dresen_thesis.tex]{subfiles}
\renewcommand{\thisPath}{\main/chapters/appendix/numericalMethods/superball}
\begin{document}
\section{Superball Form Factor}\label{ch:appendix:numericalMethods:superballFormfactor}

Nanoparticles synthesized from thermal decomposition in the size range of $10 \unit{nm}$ do not form perfectly shaped cubes but show visible rounded edges at high magnification in electron microscopy images.
This subtle difference in shape has an effect on the diffraction pattern measured in small-angle scattering.
For this purpose, a model that is closer to the observed reality than a purely cubic or spherical model is developed in the following.
A superball is a geometric body that is in between a cube and a sphere. The volume of a superball is defined by all points $(x,\, y,\, z)$ that solve
\begin{align}
x^{2p} + y^{2p} + z^{2p} < R^{2p},
\end{align}
where R is the radius.  The case $p=1$ is equivalent to the definition of a sphere and the case $p=\infty$ corresponds to a cube with edge length $a=2R$.
The amplitude $\tilde{p}(q)$ of the single-particle form factor of an oriented superball formfactor is derived in cartesian coordinates by solving
\begin{align}
  \tilde{p}(q) \eq& \frac{1}{V_p} \int_{V} \dint \vec{r} \rho(\vec{r}) e^{i \vec{q} \cdot \vec{r}}\\
  \eq& \frac{R^3}{V_p} \int_{-1}^{1} \dint x \int_{-\gamma}^{\gamma} \dint y \int_{-\zeta}^{\zeta} \dint z  e^{iR(q_x x + q_y y + q_z z)},\\
  \eq& \frac{2R^3}{q_z R V_p} \int_{-1}^{1} \dint x \int_{-\gamma}^{\gamma} \dint y  e^{i (q_x x R + q_y y R)} sin(q_z R \zeta),\\
  \mathrm{with}\nonumber\\
  \gamma \eq& \sqrt[2p]{1-x^{2p}}, \\
  \zeta \eq& \sqrt[2p]{1-x^{2p} -y^{2p}}.
\end{align}
The integral can be further simplified by splitting the integral into one for the real and one for the imaginary part
\begin{align}
  \realpart (\tilde{p}(q)) &=& \frac{2R^3}{q_z R V_p} \int_{-1}^{1} \dint x \int_{-\gamma}^{\gamma} \dint y \cos(R q_x x + R q_y y)  \sin (q_z R \zeta),\\
  \imagpart (\tilde{p}(q)) &=& \frac{2R^3}{q_z R V_p} \int_{-1}^{1} \dint x \int_{-\gamma}^{\gamma} \dint y \sin(R q_x x + R q_y y) \sin (q_z R \zeta).
\end{align}
By using that $sin(-x) \eq - sin(x)$ it is straightforward to show that the imaginary part vanishes $\imagpart (\tilde{p}(q)) \eq 0$ and only the integration over the real part has to be solved numerically to obtain the oriented form factor $\tilde{P}(q) \eq |\tilde{p}(q)|^2$. This form factor is subsequently integrated over all possible orientations and a possible size distribution to obtain the form factor $P(q)$ which can be compared to the scattering pattern obtained from diluted nanoparticles in dispersion.
Size and orientation distribution are integrated by evaluating
\begin{align}
P(q) = \frac{1}{\Omega}
\int \dint \tilde{R} g(\tilde{R})  \int \dint \varphi \int \dint \theta \sin (\theta) V_p^2 P(q),
\label{eq:superball_intensity_equation}
\end{align}
where $g$ is the log-normal size distribution
\begin{align}
g(R) = \frac{1}{\sqrt{2 \pi} \sigma_R R} \exp \Bigg[ - \frac{1}{2} \bigg(\frac{\log(R) - \log(R_0)}{\sigma_R} \bigg)^2 \Bigg],
\end{align}
and $\Omega$ the solid angle over which the orientation distribution is integrated.

When solving the five integrals numerically, great care has to be taken to make sure that on the one hand the integrals converge up to numerical precision and on the other hand the computational time stays in a reasonable time frame.
For this work, the oriented form factor amplitude is evaluated numerically at the given $q$ values by using the integration method DQAG from the fortran library QUADPACK.
DQAG uses the adaptive Gauss-Kronrod quadrature algorithm and works reliably with functions on real numbers with double precision.
The size distribution is evaluated using Gauss-Hermite quadrature as described in \ref{ch:appendix:numericalMethods:sizeDistributions}.
For the orientation distribution, the cube symmetry of the superball reduces the orientation averaging to angles $\varphi,\, \theta \in (0, 90 ^\circ)$ and thus $\Omega \eq \pi / 2$. Those two integrals are then solved by applying a Gauss-Legendre quadrature rule.
% Calculating the superball form factor for 200 $q$-values takes on a modern eight-core system about half an hour, if the size and orientation distribution integration is performed over $30$ steps each ($3 ^\circ$ steps).

The resulting form factor is multiplied with a scaling constant $I_0=N/V$ and scattering contrast $\Delta \rho^2$ to respect the particle concentration and scattering contrast relative to the medium.
\end{document}